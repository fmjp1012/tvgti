# スパース推定によるネットワーク構造学習

## 1. 問題設定

このコードは時変グラフィカル因果推論（TVGTI）のための静的モデル推定を実装しています。最適化問題として以下のように定式化されています：

$$
\min_{A,B} \frac{1}{2} \|Y - A \cdot Y - B \cdot X\|_F^2 + \lambda \|A\|_1
$$

**制約条件**:
- $\text{diag}(A) = 0$ (対角成分はゼロ)
- $B$ は対角行列

ここで：
- $\|\cdot\|_F$ はフロベニウスノルム
- $\|\cdot\|_1$ は $L_1$ ノルム（各要素の絶対値の和）
- 第1項はデータ適合項（予測誤差）
- 第2項はスパース正則化項（$A$ の疎性を促進）

## 2. モデル設定

このモデルは以下の数式で表現されます：

$$Y = A \cdot Y + B \cdot X$$

これを変形すると：

$$Y = (I - A)^{-1} \cdot B \cdot X$$

各変数の意味：
- $Y$ : 観測されたノードの状態 (サイズ $n \times c$、$n$はノード数、$c$はサンプル数)
- $A$ : ノード間の相互作用を表す行列 (サイズ $n \times n$)
  - $A_{ij}$ はノード $j$ からノード $i$ への影響度
  - 対角成分は0（自己ループなし）
- $B$ : 外部入力の影響を表す対角行列 (サイズ $n \times n$)
  - $B_{ii}$ はノード $i$ への外部入力の感度
- $X$ : 外部入力 (サイズ $n \times c$)
- $I$ : 単位行列 (サイズ $n \times n$)

## 3. データ生成方法

シミュレーションデータは以下の手順で生成されます：

1. **真のグラフ構造 $A_{true}$ の生成**:
   - $n \times n$ 行列（$n = 10$）
   - 対角成分は0
   - オフ対角成分は確率 $p = 0.3$ でランダム値（$-0.5 \sim 0.5$ の一様分布）を持つ
   - モデルの安定性確保のため、行列全体を0.2倍してスケーリング
   - これによりスペクトル半径が1未満となり、安定なシステムを表現

2. **真の影響係数 $B_{true}$ の生成**:
   - 対角行列（サイズ $n \times n$）
   - 対角成分はそれぞれ $0.5 \sim 1.5$ の一様乱数

3. **入力 $X$ の生成**:
   - $n \times c$ 行列（$n = 10$, $c = 20$）
   - 標準正規分布からサンプリング

4. **出力 $Y$ の生成**:
   - モデル式 $Y = (I - A_{true})^{-1} \cdot B_{true} \cdot X$ に従って生成
   - これは、線形システムの定常解に相当

## 4. 推定アルゴリズム：プロキシマル勾配法

プロキシマル勾配法を用いて、観測データから行列 $A$ と $B$ を推定します：

1. **初期化**:
   - $A$ : ゼロ行列
   - $B$ : 対角成分を1に初期化

2. **繰り返し処理**:
   - 残差計算: $R = Y - A \cdot Y - B \cdot X$
   - 勾配計算:
     - $A$ に関する勾配: $-R \cdot Y^T$
     - $B$ に関する勾配: 対角成分のみ $-R \cdot X^T$ の対角部分
   - パラメータ更新:
     - $A$ : 勾配ステップ + ソフトしきい値処理（$L_1$ 正則化の効果）
     - $B$ : 対角成分のみ勾配降下法で更新
   - 収束判定: 更新前後の変化がしきい値以下なら終了

### ソフトしきい値関数

$L_1$ 正則化のためのソフトしきい値関数は以下のように定義されます：

$$\text{soft\_threshold}(x, \lambda) = \text{sign}(x) \cdot \max(|x| - \lambda, 0)$$

この関数は、絶対値が $\lambda$ より小さい要素をゼロにし、それ以外の要素の絶対値から $\lambda$ を引くことで、スパース性を促進します。

## 5. 評価方法

推定されたパラメータ $A_{est}$, $B_{est}$ と真のパラメータ $A_{true}$, $B_{true}$ の差をフロベニウスノルムで測定します：

$$\text{err}_A = \|A_{est} - A_{true}\|_F$$
$$\text{err}_B = \|B_{est} - B_{true}\|_F$$

また、ヒートマップで真のパラメータと推定されたパラメータを視覚的に比較します。

## 6. 実装の特徴

- $L_1$ 正則化によるスパース構造の推定
- 対角成分に制約を持つ行列推定
- 複数のパラメータ（$A$ と $B$）の同時推定
- プロキシマル勾配法による効率的な最適化
- ハイパーパラメータ $\lambda$ によるスパース性の制御

このアルゴリズムは、ネットワーク構造（$A$ の非ゼロ要素のパターン）と各ノードの外部入力への応答（$B$ の対角成分）を同時に推定する能力を持ち、特にスパース構造の抽出に適しています。
